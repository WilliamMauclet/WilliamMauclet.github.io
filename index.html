<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>SpaceHunt</title>
</head>
<body>	
<img src="background.png" id="arena" alt="" height="600" width="900">
<img src="spaceship2.gif" id="spaceshipImg" height="32" width="32" style="position:absolute; top:35px; left:170px">
<img src="droneLeft.gif" id="drone0" height="32" width="32" style="position:absolute; top:35px; left:170px">
<img src="droneRight.gif" id="drone1" height="32" width="32" style="position:absolute; top:35px; left:170px">
<img src="droneLeft.gif" id="drone2" height="32" width="32" style="position:absolute; top:35px; left:170px">
<img src="droneRight.gif" id="drone3" height="32" width="32" style="position:absolute; top:35px; left:170px">
<img src="explosion.gif" id="exp" height="32" width="32" style="position:absolute; top:300px; left:300px">

<script>
<!-----------------------------------------INITIALISATION----------------------------------------------------->
// Do we need a constructor for spaceship? No!
var spaceship = new Movable(500, 500, 0, 4, 15, document.getElementById("spaceshipImg"));
var drones = [];
for(i = 0; i < 4; i++)
	drones.push(new Drone(i));
	
var patrolPoint = {
	x: 300,
	y: 300
}
<!------------------------------------------INITIALISATION----------------------------------------------------->


<!-----------------------------------------GAME FUNCTIONS------------------------------------------------------>
function init(){
	var ix;
	for(ix in drones)
		drones[ix].redraw();
	spaceship.redraw();
}

function gameLoop(){
	document.onkeydown = spaceship.move; //TODO needed?
	for(xyx in drones)
		drones[xyx].move();	
	
	setTimeout("gameLoop()",2);	
}
init();
//for(i=0;i<80;i++)
	gameLoop();
<!------------------------------------------GAME FUNCTIONS---------------------------------------------------->


<!-------------------------------------------PROTOTYPES------------------------------------------------------->
function Movable(x, y, orientation, speed, rotationSpeed, image) {
	// abstract prototype of spaceship & drones
	this.x = x;
	this.y = y;
	this.orientation = moduloAngle(orientation);
	this.speed = Math.abs(speed);
	this.rotationSpeed = Math.abs(rotationSpeed);
	this.image = image;
	
	this.translate = function(forNotBackwards) {
		this.x += Math.cos(toRadians(this.orientation))*this.speed*(forNotBackwards?1:-1);
		this.y += Math.sin(toRadians(this.orientation))*this.speed*(forNotBackwards?1:-1);
		reModuloCoords(this);
		this.redraw();
	};
	
	this.rotate = function(leftNotRight) {
		this.orientation += this.rotationSpeed*(leftNotRight?1:-1);
		reModuloCoords(this);
		this.redraw();
	};
	
	this.redraw = function(){
		this.image.style.top = this.x + "px";
		this.image.style.left = this.y + "px";
		rotateImage(this.image, -moduloAngle(this.orientation+180)); 
	};
}

// LASERBOLT
function LaserBolt(x,y,){
	Movable.call(this, index*30, index*120, 0, 2, 5,  document.getElementById("drone"+index));

}

// ROCKET
function Rocket(){

}

// DRONE
function Drone(index){
	// constructor for drone
	Movable.call(this, index*30, index*120, 0, 2, 5,  document.getElementById("drone"+index));
	
	this.mew = function(){
		//console.log(this.x);
	};
		
	this.move = function(){
		if(this.spaceshipInSight()){//chase
			//console.log("drone: go to spaceship");
			this.goTo(spaceship);
		}
		else // patrol 
			this.goPatrol();
	}; 
	
	this.spaceshipInSight = function(){
		var lineOfSight = 100;
		return distance(this, spaceship)<lineOfSight;
	};
	
	this.goTo = function(coord) {
		//calculate  and in directionwhich direction to rotate
		var xDiff = coord.x - this.x;
		var yDiff = coord.y - this.y;
		
		
		////console.log("this.x=" + this.x + " this.y= " + this.y);
		console.log("xdiff=" + xDiff + "  yDiff=" + yDiff);
		
		// calculate 
		var angleToFollow = toDegrees(Math.atan2(yDiff,xDiff));
		
		// Rotation to follow correctly
		var angleDiff = moduloAngle(angleToFollow - this.orientation);
		console.log("to follow: " + angleToFollow);
		////console.log("To follow:" + angleToFollow + " diff:" +angleDiff + " myAngle:" + this.orientation );
		if(Math.abs(angleDiff)>=5){
			////console.log("rotate" + (angleDiff>0?"left":"right"));
			this.rotate(angleDiff>0);
			}
		else if(distance(this, coord)<5){
			//console.log("chilling");
		}
		else{
			////console.log(Math.abs(angleDiff)<90?"forward":"backward");
			// Movement: forwards or backwards?
			// Forwards if going forward would bring you closer, else not.
			this.translate(Math.abs(angleDiff)<90); //=>stupid
			}
	};
	
	this.goPatrol = function(){
		var dist = distance(this,patrolPoint);
		if(dist>100){ 
			// drone too far to circle patrolPoint: go to it.
			//console.log("drone" + this.index + ": patrol: go to patrolPoint (distance:" + dist);
			this.goTo(patrolPoint);
			return;
		}
		
		var xDiff = patrolPoint.x - this.x;
		var yDiff = patrolPoint.y - this.y;
		// angle to follow is orthogonal to the distance-vector,
		// +90 => counterclockwise
		//var angleToFollow = toDegrees(Math.atan(yDiff/xDiff))+90;
		
		var angleToFollow = 90 + toDegrees(Math.atan2(yDiff,xDiff));
		var angleDiff = moduloAngle(angleToFollow - this.orientation);
		
		
		//console.log(angleToFollow);
		if(Math.abs(angleDiff)>5) {
			////console.log("drone" + this.circle + ": patrol: circle: ROTATE");
			this.rotate(angleDiff>0);
		}
		else {
			//console.log("drone" + this.circle + ": patrol: circle: TRANSLATE");
			this.translate(true);
		}
	}
} 
// see:  http://stackoverflow.com/questions/13040684/javascript-inheritance-object-create-vs-new
// necessary for inheritance => without it:
//	//console.log(new Drone()	instanceof Movable); => "false"
Drone.prototype = new Movable();

// SPACESHIP
spaceship.move = function(e){
		//THIS FUNCTION IS TRAVERSED BY document.onkeydown!!! => "this" is not spaceship
		// inertia!
		e = e || window.event;
		switch(e.keyCode){
			case 38: 
				//forward
				spaceship.translate(true);
				break;
			case 40: // backward
				spaceship.translate(false);
				break;
			case 37: // turn left
				spaceship.rotate(true);
				break;
			case 39: // turn right
				spaceship.rotate(false);
				break;
			case 32:
				//console.log('space');
				break;
		}
}
<!------------------------------------------PROTOTYPES----------------------------------------------------->


<!---------------------------------------GENERAL NEED FUNCTIONS----------------------------------------------->
function reModuloCoords(elem) { // with side-effect!
	elem.x = moduloValue(elem.x, parseInt(document.getElementById("arena").height));
	elem.y = moduloValue(elem.y, parseInt(document.getElementById("arena").width));
	elem.orientation = moduloAngle(elem.orientation);
}

// Returns a value between -180 and 180
function moduloAngle(degrees){
	return ((degrees+180)%360)-180;
}

function moduloValue(value, mod) {
	return ((value%mod)+mod)%mod;
}

function distance(pointA, pointB){
	var xDiff = pointB.x - pointA.x;
	var yDiff = pointB.y - pointA.y;
	return Math.sqrt(Math.pow(xDiff,2)+Math.pow(yDiff,2));
}

function toRadians(degrees){
	return degrees * Math.PI / 180;
}

function toDegrees(radians){
	return radians * 180 / Math.PI;
}

function rotateImage(elem, degrees) {
	if(navigator.userAgent.match("Chrome"))
		elem.style.WebkitTransform = "rotate("+degrees+"deg)";
	else if(navigator.userAgent.match("Firefox"))
		elem.style.MozTransform = "rotate("+degrees+"deg)";
	else if(navigator.userAgent.match("MSIE"))
		elem.style.msTransform = "rotate("+degrees+"deg)";
	else if(navigator.userAgent.match("Opera"))
		elem.style.OTransform = "rotate("+degrees+"deg)";
	else 
		elem.style.transform = "rotate("+degrees+"deg)";
}
<!------------------------------------------GENERAL NEED FUNCTIONS-------------------------------------------->
</script>


</body>
</html>